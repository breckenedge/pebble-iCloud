
#
# This file is the build configuration for the Rocky.js Pebble project.
# Rocky.js apps are pure JavaScript - no C compilation needed!
#

import os.path
try:
    from sh import CommandNotFound, jshint, cat, ErrorReturnCode_1
    hint = jshint
except (ImportError, CommandNotFound):
    hint = None

top = '.'
out = 'build'

def options(ctx):
    ctx.load('pebble_sdk')

def configure(ctx):
    ctx.load('pebble_sdk')

def build(ctx):
    if False and hint is not None:
        try:
            hint([node.abspath() for node in ctx.path.ant_glob("src/**/*.js")], _tty_out=False)
        except ErrorReturnCode_1 as e:
            ctx.fatal("\nJavaScript linting failed (you can disable this in Project Settings):\n" + e.stdout)

    ctx.load('pebble_sdk')

    # Build Rocky.js app (JavaScript only, no C compilation)
    # Rocky.js files from src/rocky/ and PebbleKit JS from src/pkjs/
    rocky_paths = ctx.path.ant_glob('src/rocky/**/*.js')
    pkjs_paths = ctx.path.ant_glob('src/pkjs/**/*.js')

    js_paths = []
    if rocky_paths:
        js_paths.extend(rocky_paths)
    if pkjs_paths:
        js_paths.extend(pkjs_paths)

    if js_paths:
        # Concatenate Rocky.js app files
        ctx(rule='cat ${SRC} > ${TGT}', source=rocky_paths, target='pebble-rocky-app.js')
        # Concatenate PebbleKit JS files
        ctx(rule='cat ${SRC} > ${TGT}', source=pkjs_paths, target='pebble-js-app.js')
        has_js = True
    else:
        has_js = False

    # Rocky.js apps don't need binary compilation
    # Just bundle the JavaScript
    ctx.set_group('bundle')
    ctx.pbl_bundle(binaries=[], js='pebble-js-app.js' if has_js else [], rocky_js='pebble-rocky-app.js' if rocky_paths else [])
